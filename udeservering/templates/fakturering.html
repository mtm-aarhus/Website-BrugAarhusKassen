{% extends "udeservering.html" %}

{% block content %}

<h4 class="mb-3">Udeservering – Fakturering</h4>

<div id="toolbar" class="d-flex gap-2">
  <button id="btnBulkGodkend" class="btn btn-success btn-sm">
    Godkend til fakturering
  </button>
  <button id="btnBulkFakturerIkke" class="btn btn-danger btn-sm">
    Fakturer ikke
  </button>
  <button id="btnBulkReset" class="btn btn-warning btn-sm">
    Opdater data
  </button>
</div>


<div class="table-responsive">
  <table id="fakturering-table"
    class="table table-striped table-bordered align-middle"
    data-toggle="table"
    data-toolbar="#toolbar"
    data-pagination="true"
    data-side-pagination="server"
    data-search="true"
    data-sort-name="DeskproID"
    data-sort-order="desc"
    data-url="{{ url_for('udeservering.api_fakturering') }}"
    data-page-size="25"
    data-unique-id="FakturaLinjeID"
    data-total-field="total"
    data-data-field="rows">
    <thead>
      <tr>
        <th data-field="state" data-checkbox="true"></th>
        <th data-field="FakturaLinjeID" data-formatter="editFormatter" data-events="editEvents"></th>
        <th data-field="DeskproID" data-sortable="true" data-formatter="linkFormatter">Sag</th>
        <th data-field="Firmanavn" data-sortable="true">Firmanavn</th>
        <th data-field="Adresse" data-sortable="true">Adresse</th>
        <th data-field="FakturaDatoSort" data-sortable="true" data-formatter="maanedAarFormatter">
            Måned
        </th>
        <th data-field="Serveringszone" data-sortable="true">Zone</th>
        <th data-field="Lokation" data-sortable="true">Lokation</th>
        <th data-field="Serveringsareal" data-sortable="true">Areal (m²)</th>
        <th data-field="Facadelaengde" data-sortable="true">Facade (m)</th>
        <th data-field="Pris" data-formatter="priceTableFormatter" data-sortable="true">Pris</th>
      </tr>
    </thead>
  </table>
</div>

{% include "fakturering_modal.html" %}

{% endblock %}

{% block extra_js %}
{{ super() }}

<script>
// ------------------------------------------
// Date formatting
// ------------------------------------------
function maanedAarFormatter(value, row) {
    return `${row.FakturaMaaned} ${row.FakturaAar}`;
}



function priceTableFormatter(value, row) {
    if (value !== null && value !== undefined) {
        return parseFloat(value).toFixed(2);
    }
    return "";
}

// ------------------------------------------
// Edit button formatter
// ------------------------------------------
function editFormatter(value, row) {
  return `
    <button class="btn btn-sm btn-primary edit-btn" data-id="${row.FakturaLinjeID}">
      <i class="bi bi-pencil-square"></i>
    </button>`;
}

// ------------------------------------------
// Row edit click handler
// ------------------------------------------
window.editEvents = {
  "click .edit-btn": function (e, value, row) {

    fetch(`/udeservering/api/fakturering/${row.FakturaLinjeID}`)
      .then(r => r.json())
      .then(json => {
        if (!json.success) return alert(json.error);

        const d = json.data;

        // Hidden fields
        document.getElementById("edit-FakturaLinjeID").value = d.FakturaLinjeID;

        // Read only
        const deskpro = document.getElementById("edit-DeskproLink");
        deskpro.textContent = d.DeskproID;
        deskpro.href = `https://ans.brugaarhus.dk/app#/t/ticket/${d.DeskproID}`;

        document.getElementById("edit-Lokation").value = d.Lokation;
        document.getElementById("edit-Periode").value = `${d.FakturaMaaned} ${d.FakturaAar}`;
        document.getElementById("edit-Serveringszone").value = d.Serveringszone;
        document.getElementById("edit-Adresse").value = d.Adresse;
        document.getElementById("edit-Firmanavn").value = d.Firmanavn ?? "";
        document.getElementById("edit-CVR").value = d.CVR ?? "";
        document.getElementById("edit-Serveringszone").value = d.Serveringszone ?? "";


        // Editable
        document.getElementById("edit-Serveringsareal").value = d.Serveringsareal ?? "";
        document.getElementById("edit-Facadelaengde").value = d.Facadelaengde ?? "";
        document.getElementById("edit-Kommentar").value = d.Kommentar ?? "";

        // Show/hide facade length + adjust column widths
        if (d.Lokation === "Ved facade") {

            // Show facade field
            document.getElementById("facade-container").style.display = "";

            // Reset columns to original layout
            document.getElementById("zone-col").className = "col-md-2";
            document.getElementById("lokation-col").className = "col-md-4";
            document.getElementById("pris-col").className = "col-md-2";
            document.getElementById("kommentar-col").className = "col-md-4";

        } else {

            // Hide facade field
            document.getElementById("facade-container").style.display = "none";
            document.getElementById("edit-Facadelaengde").value = "";

            // Apply new compact layout
            document.getElementById("zone-col").className = "col-md-1";
            document.getElementById("lokation-col").className = "col-md-5";
            document.getElementById("pris-col").className = "col-md-3";
            document.getElementById("kommentar-col").className = "col-md-6";
        }

        updateModalPrice();

        new bootstrap.Modal(document.getElementById("faktureringModal")).show();
      });
  }
};


// ------------------------------------------
// Filter select
// ------------------------------------------

// ------------------------------------------
// Modal action buttons
// ------------------------------------------
document.getElementById("btnGem").addEventListener("click", () => {
  saveUpdate({ action: "save" });
});

document.getElementById("btnSendTilFakturering").addEventListener("click", () => {
  saveUpdate({ action: "godkend" });
});

document.getElementById("btnFakturerIkke").addEventListener("click", () => {
  saveUpdate({ action: "ikke" });
});

// ------------------------------------------
// Save/update handler
// ------------------------------------------
function saveUpdate({ action }) {
  const payload = {
    FakturaLinjeID: document.getElementById("edit-FakturaLinjeID").value,
    Serveringsareal: document.getElementById("edit-Serveringsareal").value,
    Facadelaengde: document.getElementById("edit-Facadelaengde").value,
    Lokation: document.getElementById("edit-Lokation").value,
    Pris: document.getElementById("edit-Pris").value,
    Kommentar: document.getElementById("edit-Kommentar").value,
    Action: action
  };

  fetch("/udeservering/api/fakturering/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(json => {
      if (!json.success) return alert(json.error);

      $("#fakturering-table").bootstrapTable("refresh");
      bootstrap.Modal.getInstance(document.getElementById("faktureringModal")).hide();
    });
}
// ------------------------------------------
// Bulk helpers (get selected IDs)
// ------------------------------------------
function getSelectedIds() {
  const selections = $("#fakturering-table").bootstrapTable("getSelections");
  return selections.map(r => r.FakturaLinjeID);
}

// ------------------------------------------
// Bulk: Godkend til fakturering
// ------------------------------------------
document.getElementById("btnBulkGodkend").addEventListener("click", () => {
  const ids = getSelectedIds();
  if (ids.length === 0) {
    alert("Vælg mindst én linje først.");
    return;
  }

  if (!confirm(`Godkend ${ids.length} linje(r) til fakturering?`)) return;

    fetch("/udeservering/api/fakturering/bulk_godkend", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ ids })
    })

    .then(r => r.json())
    .then(j => {
      if (!j.success) return alert(j.error);
      $("#fakturering-table").bootstrapTable("refresh");
    });
});

// ------------------------------------------
// Bulk: Fakturer ikke
// ------------------------------------------
document.getElementById("btnBulkFakturerIkke").addEventListener("click", () => {
  const ids = getSelectedIds();
  if (ids.length === 0) {
    alert("Vælg mindst én linje først.");
    return;
  }

  if (!confirm(`Markér ${ids.length} linje(r) som 'Fakturer ikke'?`)) return;

  fetch("/udeservering/api/fakturering/bulk_status", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ ids, Action: "ikke" })
  })
    .then(r => r.json())
    .then(j => {
      if (!j.success) return alert(j.error);
      $("#fakturering-table").bootstrapTable("refresh");
    });
});

// ------------------------------------------
// Bulk: Opdater data (slet linjer)
// ------------------------------------------
document.getElementById("btnBulkReset").addEventListener("click", () => {
  const ids = getSelectedIds();
  if (ids.length === 0) {
    alert("Vælg mindst én linje først.");
    return;
  }

  if (!confirm(`Slet ${ids.length} linje(r) og generér nye ved næste synkronisering?`)) return;

  fetch("/udeservering/api/fakturering/reset_bulk", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ ids })
  })
    .then(r => r.json())
    .then(j => {
      if (!j.success) return alert(j.error);
      $("#fakturering-table").bootstrapTable("refresh");
    });
});


// ------------------------------------------
// Pris auto calculator
// ------------------------------------------
async function updateModalPrice() {
    const payload = {
        Zone: document.getElementById("edit-Serveringszone").value,
        Lokation: document.getElementById("edit-Lokation").value,
        Serveringsareal: document.getElementById("edit-Serveringsareal").value,
        Facadelaengde: document.getElementById("edit-Facadelaengde").value,
        Month: extractMonthNumber(document.getElementById("edit-Periode").value)
    };

    const response = await fetch("/udeservering/api/beregn_pris", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });

    const json = await response.json();
    if (!json.success) return;

    const d = json.data;

    document.getElementById("edit-Pris").value = d.belob;
}

function extractMonthNumber(str) {
    const map = {
        "Januar": 1, "Februar": 2, "Marts": 3, "April": 4,
        "Maj": 5, "Juni": 6, "Juli": 7, "August": 8,
        "September": 9, "Oktober": 10, "November": 11, "December": 12
    };
    const navn = str.split(" ")[0];
    return map[navn] || 0;
}


["edit-Serveringsareal", "edit-Facadelaengde"].forEach(id => {
  document.getElementById(id).addEventListener("input", updateModalPrice);
});

// Reset (Opdater data)
document.getElementById("btnResetData").addEventListener("click", () => {
    const id = document.getElementById("edit-FakturaLinjeID").value;

    if (!confirm("Dette vil slette fakturalinjen, og generere en ny med opdateret data fra BrugAarhus ved næste synkronisering.")) return;

    fetch("/udeservering/api/fakturering/reset", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ FakturaLinjeID: id })
    })
    .then(r => r.json())
    .then(j => {
        if (!j.success) return alert(j.error);
        $("#fakturering-table").bootstrapTable("refresh");
        bootstrap.Modal.getInstance(document.getElementById("faktureringModal")).hide();
    });
});



</script>
{% endblock %}
