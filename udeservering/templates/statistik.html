{% extends "udeservering.html" %}
{% block content %}
<div class="container-fluid">

  <div class="row mb-3">
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-3"><i class="bi bi-graph-up"></i> Statistik over fakturastatus</h5>
          <div id="statusCounts" class="small text-secondary">
            IndlÃ¦ser statistik...
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title mb-3"><i class="bi bi-bar-chart"></i> Samlet oversigt</h5>
          <div id="totalCounts" class="small text-secondary">
            IndlÃ¦ser totaler...
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table id="statistik-table"
           class="table table-striped table-hover align-middle"
           data-toggle="table"
           data-pagination="true"
           data-search="true"
           data-url="{{ url_for('udeservering.api_udeservering_statistik_table') }}"
           data-page-size="25"
           data-unique-id="Id">
      <thead>
        <tr>
          <th data-field="Id" data-formatter="linkFormatter">ID</th>
          <th data-field="Firmanavn">Firma</th>
          <th data-field="Adresse">Adresse</th>
          <th data-field="CVR">CVR</th>
          <th data-field="Serveringszone">Zone</th>
          <th data-field="Lokation">Lokation</th>
          <th data-field="Serveringsareal" data-formatter="arealFormatter">Areal</th>
          <th data-field="Facadelaengde" data-formatter="facadeFormatter">FacadelÃ¦ngde</th>
          <th data-field="MaanederJson" data-formatter="monthsOptionFormatter">MÃ¥neder</th>
          <th data-field="FakturaStatus">Fakturastatus</th>
        </tr>
      </thead>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Fetch metrics summary (status counts and totals)
  fetch("{{ url_for('udeservering.api_udeservering_statistik_metrics') }}")
    .then(r => r.json())
    .then(data => {
      const s = data.status || {};
      const t = data.totals || {};

      const statusHTML = `
        <ul class="list-unstyled mb-0">
          <li>ðŸŸ¢ <strong>Ny:</strong> ${s.Ny || 0}</li>
          <li>ðŸŸ  <strong>Til fakturering:</strong> ${s.TilFakturering || 0}</li>
          <li>ðŸ”µ <strong>Faktureret:</strong> ${s.Faktureret || 0}</li>
          <li>ðŸ”´ <strong>Fakturer ikke:</strong> ${s.FakturerIkke || 0}</li>
        </ul>`;
      const totalsHTML = `
        <ul class="list-unstyled mb-0">
          <li><strong>Antal linjer:</strong> ${t.rows || 0}</li>
          <li><strong>Unikke firmaer:</strong> ${t.firms || 0}</li>
        </ul>`;

      document.getElementById("statusCounts").innerHTML = statusHTML;
      document.getElementById("totalCounts").innerHTML = totalsHTML;
    })
    .catch(() => {
      document.getElementById("statusCounts").innerText = "Kunne ikke hente statistik.";
      document.getElementById("totalCounts").innerText = "Kunne ikke hente totaler.";
    });
});
</script>
{% endblock %}
