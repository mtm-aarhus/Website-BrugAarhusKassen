{% extends "common.html" %}

{% block extra_head %}
{# Optional: Add CSS only for Udeservering pages #}
{% endblock %}

{% block content %}
{# Each child page will override this #}
{% endblock %}

{% block extra_js %}
<script>

function getSelectedIdsGeneric(tableId) {
    const selections = $(tableId).bootstrapTable("getSelections");
    return selections.map(r => r.FakturaLinjeID);
}

function bulkUpdateStatus(ids, action, callback) {
    fetch("/udeservering/api/fakturering/bulk_status", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ ids, Action: action })
    })
    .then(r => r.json())
    .then(j => {
        if (!j.success) return alert(j.error);
        callback();
    });
}

function bulkDelete(ids, callback) {
    fetch("/udeservering/api/fakturering/reset_bulk", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ ids })
    })
    .then(r => r.json())
    .then(j => {
        if (!j.success) return alert(j.error);
        callback();
    });
}

function maanedAarFormatter(value, row) {
    return `${row.FakturaMaaned} ${row.FakturaAar}`;
}

document.getElementById("resetTriggerBtn").addEventListener("click", async () => {
    if (!confirm("Tryk OK for at igangsÃ¦tte synkronisering. Tager typisk 1-2 minutter, og browseren skal herefter opdateres")) return;

    const r = await fetch("/udeservering/api/run_refresh", { method: "POST" });
    const j = await r.json();
});

const MONTH_OPTION_ID_TO_NAME = {
  1198: "Januar", 1199: "Februar", 1200: "Marts", 1201: "April",
  1202: "Maj", 1203: "Juni", 1204: "Juli", 1205: "August",
  1206: "September", 1207: "Oktober", 1208: "November", 1209: "December",
  1306: "April", 1307: "Maj", 1308: "Juni", 1309: "Juli", 1310: "August"
};

function monthsOptionFormatter(value) {
  if (!value) return "";
  try {
    const arr = JSON.parse(value);
    if (!Array.isArray(arr)) return String(value);

    const names = arr.map(x => {
      const id = parseInt(x, 10);
      return MONTH_OPTION_ID_TO_NAME[id] || String(x);
    });

    // de-dupe while preserving order
    const seen = new Set();
    return names.filter(n => (seen.has(n) ? false : seen.add(n))).join(", ");
  } catch {
    return String(value);
  }
}

function boolFormatter(value) {
  // SQLAlchemy may return true/false, 0/1, or "0"/"1"
  return (value === true || value === 1 || value === "1") ? "Ja" : "Nej";
}
</script>
{% endblock %}
